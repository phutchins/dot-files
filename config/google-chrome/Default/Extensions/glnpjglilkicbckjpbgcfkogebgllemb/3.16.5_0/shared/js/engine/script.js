System.expect("locateElement");System.expect("locateForm");System.expect("waitFor");System.expect("Overlay");System.expect("ENV");System.expect("Log");function Script(p,o,k,m){Log.debug("Script");var z=20*1000;var v=null;var d=null;Log.debug("Creating script for "+m);if(o==null){Log.debug("There are no actions!?")}function a(A){Log.debug("Script::showProgress");if(!v){v=new Overlay("okta-overlay",A.message,50000);v.open(A.document)}}function y(B){Log.debug("Script::_monitorSubmit");if(d){clearTimeout(d)}var A=l(B);d=setTimeout(function(){Log.debug("Script::_monitorSubmit Checking the form for changes");var C=false;switch(B.action.type){case"click":C=!!locateElement(B,false,false);break;case"submit":C=!!locateForm(B,false);break;case"autoLogin":C=!!u(B)}if(C&&l(B)===A){B.error("It looks like the form was not submitted to the server")}},z)}function l(A){return $okta("*:visible",A.document).not("#okta-overlay, #okta-overlay *, #okta-overlay-div, #okta-overlay-div *").length}function c(B){Log.debug("Script::doClick");var A=locateElement(B,false,true);a(B);y(B);if(typeof A.submit=="function"){A.submit()}else{t(A,"mousedown");t(A,"mouseup");t(A,"click")}B.next()}function q(D){Log.debug("Script::doType");var C=locateElement(D,true,true);for(var B=0;B<C.length;B++){var A=$okta(C[B]);if(A.is(":visible")){t(A,"focus");t(A,"keydown");t(A,"keypress")}A.attr("value",D.action.value);if(A.is(":visible")){t(A,"input");t(A,"keyup")}t(A,"change")}D.next()}function t(C,A,B){try{$okta(C).simulate(A,B)}catch(D){Log.error("Error triggering event '"+A+"': ",D)}}function h(A){Log.debug("Script::doWaitForElement");var B=null;waitFor({timeout:ENV.DefaultTimeout,delay:ENV.DefaultWaitDelay,success:A.next,condition:function(){try{locateElement(A,false,true);return true}catch(C){B=C;return false}},timedout:function(){A.error("Could not locate element before timeout: "+B)}})}function w(A){Log.debug("Script::doIfElementPresent");if(locateElement(A,false,false)){Log.debug("Found element - executing sub-commands");new Script(A.message,A.action.action,A.error).execute(A.document,A.window,A.next)}else{Log.debug("Did not find element - moving to next action");A.next()}}function r(A){Log.debug("Script::_doNoOp");A.next()}function j(A){Log.debug("Script::doWaitForVisible");var B=null;waitFor({timeout:ENV.DefaultTimeout,delay:ENV.DefaultWaitDelay,success:A.next,condition:function(){try{var E=locateElement(A,false,true);var F=E.offsetWidth;var C=E.offsetHeight;return(F!==0||C!==0)&&E.style.display!=="none"}catch(D){B=D;return false}},timedout:function(){A.error("Could not locate element before timeout: "+B)}})}function x(B){Log.debug("Script::_doSubmit");var A=locateForm(B,true);y(B);A.submit();B.next()}function s(B){Log.debug("Script::doFireEvent");var A=locateElement(B,false,true);Log.debug("firing event: ["+B.action.eventName+"]");t(A,B.action.eventName);B.next()}function g(A){Log.debug("Script::doRedirect");A.document.location=A.action.url}function n(A){Log.debug("Script::doCloseOverlay");if(v){v.close();v=null}A.next()}function i(B){Log.debug("Script::_doSleep");var A=B.action.value||0;Log.debug("Going idle for "+A+"ms");setTimeout(B.next,A)}function f(A){Log.debug("Script::doAutoLogin");A.action.element="css=form";var B=null;waitFor({timeout:20000,delay:500,success:A.next,condition:function(){try{var D=u(A);if(D){Log.debug("Autologin: found login form");D.fillCreds(A.action);y(A);D.submit();return true}else{return false}}catch(C){B=C;return false}},timedout:function(){A.error("Autologin: Could not find login form before timeout: "+B)}})}function u(F){var C=_okta.chain(locateElement({action:{element:"css=iframe,frame"},document:F.document,window:F.window},true,false)).map(function(H){try{Log.debug("Frame: {0}",H.src);return $okta(H).contents()[0]}catch(G){Log.debug("Unable to search for a login form inside frame: {0}. Error: {1}",H.src,G)}}).compact().unshift(F.document).value();for(var B=0;B<C.length;B++){var A=C[B];try{Log.debug("Looking for a login form on {0}",A.location.href);var D=_okta.chain(locateElement({action:F.action,document:A,window:F.window},true,false)).map(function(G){return new Okta.Form(G)}).find(function(G){return G.isLoginForm()}).value();if(D){return D}}catch(E){Log.debug("Unable to find login form on {0}. Error: {1}",A.location.href,E)}}}var b={click:c,type:q,waitForElementPresent:h,ifElementPresent:w,"no-op":r,submit:x,waitForVisible:j,fireEvent:s,redirect:g,closeOverlay:n,sleep:i,autoLogin:f};function e(G,F,A,H,I,J){Log.debug("Script::nextAction");if(I.length){Log.debug("There are "+I.length+" actions remaining");var C=I.shift();if(C.frame&&!C.__waitForElementPresent_injected__){C.__waitForElementPresent_injected__=true;I.unshift(C);C={type:"waitForElementPresent",element:C.element,frame:C.frame,id:C.id,name:C.name,value:C.value}}var D=b[C.type];if(D){try{var B={action:C,document:G,window:F,message:J,error:H,next:function(){setTimeout(function(){e(G,F,A,H,I,J)},0)}};D(B)}catch(E){H(E)}}else{H("Could not find command for "+C.type)}}else{Log.debug("Script complete");if(A){A()}}}this.execute=function(A,D,C){Log.debug("Script::execute");var B=o.slice();e(A,D,C,k,B,p)};this.getState=function(){return{actions:o,overlayMessage:p,statusURI:m}}};