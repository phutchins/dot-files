System.expect("Log");System.expect("OktaApiClient");System.expect("Script");var NOT_YET_IN_FLOW=new Object();var TOP_DOCUMENT_EXPECTED=new Object();var OTHER_FRAME_EXPECTED=new Object();function SiteFlow(c){var d=this;Log.debug("SiteFlow");var g={};var b={};var f;var e;var h=false;this.getState=function(){return{urls:g,scripts:b,message:f,statusURI:e,enteredFlow:h}};this.load=function(i){g=i.urls;b=i.scripts;f=i.message;e=i.statusURI;h=i.enteredFlow};this.init=function(l){f=l&&l.progressMessage?l.progressMessage:"Signing in...";e=l&&l.callbackURI?l.callbackURI:null;var k=null;if(l.scriptURI){Log.debug("Hitting "+l.scriptURI+" to retrieve flow for site");k=c.fetchJSON(l.scriptURI)}else{if(l.urls){k=l}}if(k){Log.debug("There are "+k.urls.match.length+" urls");g=k.urls.match;if(k.scripts){Log.debug("There are "+k.scripts.script.length+" scripts");for(var m=0;m<k.scripts.script.length;m++){var j=k.scripts.script[m];Log.debug("Saving script "+j.name);b[j.name]=j}}}};this.nextURL=function(o,n){Log.debug("SiteFlow::nextURL");var l=o.href;var q=false;for(var m=0;m<g.length;m++){q|=!!g[m].matchFrames;if(!g[m].matchFrames&&!n.isTopWindow){Log.debug("Pattern "+g[m].url+" does not allow frames; skipped");continue}if(o.matches(g[m].url,g[m].isRegex)){Log.debug("Pattern "+g[m].url+" matches "+l);h=true;var p=this._getActions(g[m]);var k=new Script(f,p,a(l),e);var j;if(g[m].next){Log.debug("There are more steps to go - saving state");g=g[m].next.match;j=false}else{Log.debug("We've reached the end of the flow");g={};b={};j=true}return{script:k,lastInFlow:j}}}if(h){if(q){Log.debug("Could not find script for "+l+"; probably a wrong frame");return OTHER_FRAME_EXPECTED}else{if(!n.isTopWindow){Log.debug("Could not find script for "+l+"; top document expected");return TOP_DOCUMENT_EXPECTED}}Log.debug("Could not find script for "+l);return null}else{Log.debug("Could not find script for "+l+"; not yet in flow");return NOT_YET_IN_FLOW}};this._getActions=function(j){Log.debug("SiteFlow::_getActions");if(j.scriptName){Log.debug("Using script "+j.scriptName);var i=b[j.scriptName];if(!i){return null}return i.action}else{if(j.script){Log.debug("Using embedded script");return j.script.action}else{Log.debug("No script for matching URL");return null}}};function a(i){return function(j){Log.error(i+": "+j);if(e){c.post(e,{e:true,u:i,m:j,v:PLUGIN_VERSIONS.currentVersion})}}}};