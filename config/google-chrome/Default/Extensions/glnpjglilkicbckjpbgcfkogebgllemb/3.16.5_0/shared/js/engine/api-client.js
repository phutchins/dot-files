System.expect("PLUGIN_VERSIONS");System.expect("ENV");System.expect("StringUtil");System.expect("Log");System.expect("HttpRequest");function OktaApiClient(a,c,q){Log.debug("OktaApiClient");var p=this;var i=PLUGIN_VERSIONS.protocolVersion;function j(){if(q&&q.isFirefox){return a.getPersistentState(OKTA_GLOBAL_KEYS.SESSION_COOKIE)}return a.getGlobalState(OKTA_GLOBAL_KEYS.SESSION_COOKIE)}function o(r){a.setPersistentState(OKTA_GLOBAL_KEYS.MONITORED_SITES,r)}function h(){return a.getPersistentState(OKTA_GLOBAL_KEYS.MONITORED_SITES,[])}function e(r){a.setPersistentState(OKTA_GLOBAL_KEYS.AUTH_SITES,r)}function m(){return a.getPersistentState(OKTA_GLOBAL_KEYS.AUTH_SITES,[])}function d(r){a.setPersistentState(OKTA_GLOBAL_KEYS.FORM_SITES_NO_PW,r)}function k(){return a.getPersistentState(OKTA_GLOBAL_KEYS.FORM_SITES_NO_PW)}function n(t,r){var s=a.getSessionState(OKTA_SESSION_KEYS.CACHED_REQUESTS,{});s[t]=r;a.setSessionState(OKTA_SESSION_KEYS.CACHED_REQUESTS,s)}function l(s){var r=a.getSessionState(OKTA_SESSION_KEYS.CACHED_REQUESTS,{});return r[s]}function g(s){if($okta.browser.safari&&!window.chrome){var r=j();if(r){s["X-Session-Id"]=r.sid;s["X-Device-Token"]=r.DT}}return s}this.clearCachedRequests=function(){a.setSessionState(OKTA_SESSION_KEYS.CACHED_REQUESTS,{})};this.setPluginSettings=function(r){a.setPersistentState(OKTA_PERSISTANT_KEYS.PLUGIN_SETTINGS,r)};this.getPluginSettings=function(){var r=a.getPersistentState(OKTA_PERSISTANT_KEYS.PLUGIN_SETTINGS,{override:{},orgSettings:{}});return r};this.getNormalizedSettings=function(r){return $okta.extend({},r.orgSettings,r.overrides)};this.findSite=function(s){Log.skipAudit("OktaApiClient::findSite: "+s.href);var r=_okta(h()).filter(function(t){return s.matches(t.siteURL)});return r&&r.length==1?r[0]:null};this.findAuthSite=function(s){var r=_okta(m()).filter(function(t){return s.matches(t.authURL)});return r&&r.length==1?r[0]:null};this.fetchJSON=function(s,r){Log.debug("OktaApiClient::fetchJSON ({0}): {1}",r&&r.async?"async":"sync",s);return a.ajax({type:"get",url:c.getOktaDomain()+s,headers:g({Accept:"application/json;charset=utf-8"}),failure:function(t){Log.error("Error: "+t.status+": "+t.statusText);if(r&&r.onerror){r.onerror(JSON.parse(t.responseText))}return null}},r)};this.fetchCachedJSON=function(t,r){Log.debug("OktaApiClient::fetchCachedJSON: "+t);var s=l(t);if(!s){s=this.fetchJSON(t,r);n(t,s)}else{if(r&&r.oncomplete){r.oncomplete(s)}}return s};this.forceLoadSites=function(r){f(true,r)};this.loadSitesIfNotLoaded=function(r){f(true,r)};function f(s,r){Log.debug("OktaApiClient::loadSites");if(!s){if(h().length>0||m().length>0){if(r&&r.oncomplete){r.oncomplete()}return}}p.fetchJSON("/api/plugin/"+i+"/sites",$okta.extend(true,{},r,{oncomplete:function(t){b(t);if(r&&r.oncomplete){r.oncomplete()}}}))}function b(t){var r;if(t){Log.debug("Updating sites list: "+t.site.length+" sites monitored");for(r=0;r<t.site.length;r++){Log.debug("Monitoring "+t.site[r].siteURL)}o(t.site);Log.debug("Updating auth sites list: "+t.authSite.length+" auth sites");for(r=0;r<t.authSite.length;r++){Log.debug("Monitoring "+t.authSite[r].authURL)}e(t.authSite);d(t.formSites);var s=p.getPluginSettings();s.orgSettings=t.pluginSettings;p.setPluginSettings(s)}else{Log.error("No sites returned");o([]);e([]);d([])}}this.post=function(s,t){Log.debug("OktaApiClient::post: "+s);var r=j();a.ajax({type:"post",url:c.getOktaDomain()+s,data:t,headers:g({"Plugin-Sid":r?r.sid:null,Accept:"application/json;charset=utf-8"}),failure:function(u){Log.error("Error: "+u.status+": "+u.statusText)}})};this.setSessionCookie=function(s,r){Log.debug("OktaApiClient::setSessionCookie: "+s+" "+r);if(q&&q.isFirefox){a.setPersistentState(OKTA_GLOBAL_KEYS.SESSION_COOKIE,{sid:s,DT:r})}else{a.setGlobalState(OKTA_GLOBAL_KEYS.SESSION_COOKIE,{sid:s,DT:r})}};this.getBookmarks=function(){Log.debug("OktaApiClient::getBookmarks");return p.fetchJSON("/api/plugin/"+i+"/bookmarks")};this.updateCredential=function(r,t,s){Log.debug("OktaApiClient::updateCredential: {0}",{appUserId:r,username:t,password:s});p.post("/api/plugin/"+i+"/updateCredential",{i:r,un:t,p:s});f(true)};this.getFormSites=function(v,t,s){var w;if(v instanceof Okta.Url){w=_okta(p.getFormSitesNoPw(v)).map(function(x){return x.id})}else{w=v}if(!w.length){throw"OktaApiClient::getFormSites: no match"}var u=t?"Username":"FullCred";var r=p.fetchCachedJSON("/api/plugin/"+i+"/form-creds/"+w.join(",")+"/"+u,s);return r?r:[]};this.getFormSitesNoPw=function(r){Log.skipAudit("OktaApiClient::getFormSitesNoPw: "+r.href);return _okta(k()).filter(function(s){return r.matches(s.urlRegex,true)})}};