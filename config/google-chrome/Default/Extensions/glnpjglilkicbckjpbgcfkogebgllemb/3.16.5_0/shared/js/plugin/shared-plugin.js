function SharedPlugin(b,l,s){var h=10*1000;var n=this;var o;var q;function f(){return b.getGlobalState(OKTA_GLOBAL_KEYS.AUDIT_DATA,undefined)}function e(u){return b.setGlobalState(OKTA_GLOBAL_KEYS.AUDIT_DATA,u)}function p(){return b.getSessionState(OKTA_SESSION_KEYS.PERSISTED,{})}function a(u){b.setSessionState(OKTA_SESSION_KEYS.PERSISTED,u)}var r;function m(u){Log.debug("SharedContentScript::unpersist: "+u);var v=p();delete v[u];a(v)}function g(u,w){Log.debug("SharedContentScript::persist: "+u);var v=p();v[u]=w;a(v)}function t(u){return b.getGlobalState("autoSubmit-"+u,0)}function j(v,u){b.setGlobalState("autoSubmit-"+v,u)}function i(v){var u=new Date().getTime();if(!v.toolbarAutosubmit){return false}else{if(u-t(v.id)<h){Log.warn("Trying to auto-submit again too quickly, throttling.");return false}else{j(v.id,u);return true}}}function k(u){Log.debug("SharedPlugin::monitorSps");b.setSessionState(OKTA_SESSION_KEYS.CURRENT_SPS,u)}function d(){var u=b.getSessionState(OKTA_SESSION_KEYS.CURRENT_SPS);return u}this.onMessageFromContentScript=function(v,A,x,B,w){Log.info("SharedPlugin::onMessageFromContentScript: tabId: {0}, url: {1}, request: {2}",v,A.href,x);var y=x.data||{};switch(x.type){case"registerSubmit":if(!r.inIgnoreList(A)){var u=q.processFormCapture(A,y.formCapture);if(u){if(u.promptSave){if(u.formData.username&&u.formData.passwords.length==1){g(v,u);B("showSavePasswordBar",{showSavePasswordBar:u})}}else{if(u.exactUserPassLogin){m(v)}}}}break;case"clearPersistedPasswordBar":m(v);break;case"neverThisUrl":r.addToIgnoreList(A);break;case"doSave":l.updateCredential(y.appUserId,y.username,y.password);l.clearCachedRequests();break;case"getCredToFill":var z=l.getFormSites([y.id])[0];Log.debug("getCredToFill: {0}",z);B("fillCred",{cred:z});break;case"foundLoginOrPasswordForm":l.getFormSites(y.ids,true,{oncomplete:function(D){if(!y.changePwForm&&i(D[0])){var C=l.getFormSites([D[0].id])[0];Log.debug("autoSubmit: {0}",C);B("autoSubmit",{cred:C});return}Log.debug("showBarWithUsername: {0}",D);B("showBarWithUsername",{creds:D,changePwForm:y.changePwForm})},onerror:function(C){Log.debug("getFormSites error: "+C.errorCode);if(C.errorCode==="E0000005"){B("showBarWithLogin",{appUserId:y.ids[0]})}if(C.errorCode==="E0000058"){var D=C.errorSummary.split(" ").pop();B("showBarWithMFA",{ruleId:D,appUserId:y.ids[0]})}if(C.errorCode==="E0000057"){Log.debug("Policy deny exception")}}});break;case"loggedOutFromApp":j(y.appId,new Date().getTime());break;case"PopupClosed":B("PopupClosed",{});break;case"monitorSps":k(y.spsInfo);break;case"reportSpsStatus":l.post(y.oktaUri,{e:y.isError,u:y.url,m:y.message,v:PLUGIN_VERSIONS.currentVersion});break}};this.pageLoaded=function(v,x,y){l.clearCachedRequests();if(!r.inIgnoreList(x)){var u=l.getFormSitesNoPw(x);u=_okta(u).select(function(z){return z.isFullCred});var w=l.getPluginSettings();y("init",{oktaDomain:s.getOktaDomain(),settings:l.getNormalizedSettings(w),audit:f(),matchedFullCredSitesNoPw:u,showSavePasswordBar:p()[v],currentSps:d()});if(s.isOktaHome(x)){y("LoginHomePage",{})}else{if(s.isOktaPluginInterstitial(x)){y("preloadSpinner")}else{if(s.isOktaEmbedLoginPage(x)){y("EmbedLoginPage")}}}}else{Log.info("SharedPlugin::pageLoaded: url: {0} - ignored URL for the toolbar.",x.href)}};this.setCookies=function(v){var u=new Cookies(v);l.setSessionCookie(u.getCookie("sid"),u.getCookie("DT"))};this.processHomePageUrl=function(w,v,u){this.setCookies(v);l.forceLoadSites($okta.extend(true,{},u,{oncomplete:function(){c(w);if(u&&u.oncomplete){u.oncomplete()}}}))};function c(A){var z=l.getPluginSettings();var y=A.queryKey["plugin-overrides"];if(y){y=y.split(",");var B={};for(var x=0;x<y.length;x++){B[y[x]]=true}z.overrides=B;l.setPluginSettings(z)}var v=f();var u=A.queryKey["audit-plugin"];if(u){r.clearIgnoreList();u=u.split(",");for(var x=0;x<u.length;x++){u[x]=decodeURIComponent(u[x])}v={passwords:u};e(v)}else{if(v==undefined){e(false);v=false}}var w=l.getNormalizedSettings(z);Log.init(w.outputToConsole,v)}this.init=function(){r=new Okta.Storage(b);Log.init(l.getPluginSettings().outputToConsole);q=new FormProcessor();q.init(l)}};